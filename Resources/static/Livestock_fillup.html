<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>New Farmers Info</title>
    <link rel="stylesheet" href="Livestock_fillup.css">
</head>
<body>
    <div class="container">
     
        <div class="header">
            <h1>New Farmers Info</h1>
            <button class="back-btn" onclick="goBack()">Back</button>
        </div>

        <div class="form-container">
         
            <div class="left-section">
                <div class="form-group">
                    <label for="farmerName">Farmer's Name</label>
                    <input type="text" id="farmerName" placeholder="Enter farmer name">
                </div>
                <div class="form-group">
                    <label for="contact">Contact</label>
                    <input type="text" id="contact" placeholder="Enter phone number">
                </div>
                <div class="form-group">
                    <label for="age">Age</label>
                    <input type="number" id="age" min="0" max="120" step="1" required placeholder="Enter age">
                </div>
                <div class="form-group">
                    <label for="sex">Sex</label>
                    <select id="sex">
                        <option value=""> </option>
                        <option value="M">Male</option>
                        <option value="F">Female</option>
                        <option value="O">Other</option>
                    </select>
                </div>
            </div>

          
            <div class="right-section">
                <div class="livestock-header">Livestock Data</div>
                <div class="livestock-grid">

                    <div class="grid-row">
                        <div class="animal-item">
                            <label>Cattle</label>
                            <div class="input-group">
                                <div class="input-with-label"><span>M</span> <input type="number" id="cattle_male" min="0" max="50" value="0"></div>
                                <div class="input-with-label"><span>F</span> <input type="number" id="cattle_female" min="0" max="50" value="0"></div>
                            </div>
                        </div>
                        <div class="animal-item">
                            <label>Quail</label>
                            <div class="input-group">
                                <div class="input-with-label"><span>M</span> <input type="number" id="quail_male" min="0" max="50" value="0"></div>
                                <div class="input-with-label"><span>F</span> <input type="number" id="quail_female" min="0" max="50" value="0"></div>
                            </div>
                        </div>
                    </div>

                    <div class="grid-row">
                        <div class="animal-item">
                            <label>Carabao</label>
                            <div class="input-group">
                                <div class="input-with-label"><span>M</span> <input type="number" id="carabao_male" min="0" max="50" value="0"></div>
                                <div class="input-with-label"><span>F</span> <input type="number" id="carabao_female" min="0" max="50" value="0"></div>
                            </div>
                        </div>
                        <div class="animal-item">
                            <label>Turkey</label>
                            <div class="input-group">
                                <div class="input-with-label"><span>M</span> <input type="number" id="turkey_male" min="0" max="50" value="0"></div>
                                <div class="input-with-label"><span>F</span> <input type="number" id="turkey_female" min="0" max="50" value="0"></div>
                            </div>
                        </div>
                    </div>

                    <div class="grid-row">
                        <div class="animal-item">
                            <label>Horse</label>
                            <div class="input-group">
                                <div class="input-with-label"><span>M</span> <input type="number" id="horse_male" min="0" max="50" value="0"></div>
                                <div class="input-with-label"><span>F</span> <input type="number" id="horse_female" min="0" max="50" value="0"></div>
                            </div>
                        </div>
                        <div class="animal-item">
                            <label>Geese</label>
                            <div class="input-group">
                                <div class="input-with-label"><span>M</span> <input type="number" id="geese_male" min="0" max="50" value="0"></div>
                                <div class="input-with-label"><span>F</span> <input type="number" id="geese_female" min="0" max="50" value="0"></div>
                            </div>
                        </div>
                    </div>

                    <div class="grid-row">
                        <div class="animal-item">
                            <label>Goat</label>
                            <div class="input-group">
                                <div class="input-with-label"><span>M</span> <input type="number" id="goat_male" min="0" max="50" value="0"></div>
                                <div class="input-with-label"><span>F</span> <input type="number" id="goat_female" min="0" max="50" value="0"></div>
                            </div>
                        </div>
                        <div class="animal-item">
                            <label>Dove</label>
                            <div class="input-group">
                                <div class="input-with-label"><span>M</span> <input type="number" id="dove_male" min="0" max="50" value="0"></div>
                                <div class="input-with-label"><span>F</span> <input type="number" id="dove_female" min="0" max="50" value="0"></div>
                            </div>
                        </div>
                    </div>

                    <div class="grid-row">
                        <div class="animal-item">
                            <label>Sheep</label>
                            <div class="input-group">
                                <div class="input-with-label"><span>M</span> <input type="number" id="sheep_male" min="0" max="50" value="0"></div>
                                <div class="input-with-label"><span>F</span> <input type="number" id="sheep_female" min="0" max="50" value="0"></div>
                            </div>
                        </div>
                        <div class="animal-item">
                            <label>Dog</label>
                            <div class="input-group">
                                <div class="input-with-label"><span>M</span> <input type="number" id="dog_male" min="0" max="50" value="0"></div>
                                <div class="input-with-label"><span>F</span> <input type="number" id="dog_female" min="0" max="50" value="0"></div>
                            </div>
                        </div>
                    </div>

                    <div class="grid-row">
                        <div class="animal-item">
                            <label>Swine</label>
                            <div class="input-group">
                                <div class="input-with-label"><span>M</span> <input type="number" id="swine_male" min="0" max="50" value="0"></div>
                                <div class="input-with-label"><span>F</span> <input type="number" id="swine_female" min="0" max="50" value="0"></div>
                            </div>
                        </div>
                        <div class="animal-item">
                            <label>Guinea Fowl</label>
                            <div class="input-group">
                                <div class="input-with-label"><span>M</span> <input type="number" id="guinea_fowl_male" min="0" max="50" value="0"></div>
                                <div class="input-with-label"><span>F</span> <input type="number" id="guinea_fowl_female" min="0" max="50" value="0"></div>
                            </div>
                        </div>
                    </div>

                    <div class="grid-row">
                        <div class="animal-item">
                            <label>Chicken</label>
                            <div class="input-group">
                                <div class="input-with-label"><span>M</span> <input type="number" id="chicken_male" min="0" max="50" value="0"></div>
                                <div class="input-with-label"><span>F</span> <input type="number" id="chicken_female" min="0" max="50" value="0"></div>
                            </div>
                        </div>
                        <div class="animal-item">
                            <label>Game Fowl</label>
                            <div class="input-group">
                                <div class="input-with-label"><span>M</span> <input type="number" id="game_fowl_male" min="0" max="50" value="0"></div>
                                <div class="input-with-label"><span>F</span> <input type="number" id="game_fowl_female" min="0" max="50" value="0"></div>
                            </div>
                        </div>
                    </div>

                    <div class="grid-row">
                        <div class="animal-item">
                            <label>Duck</label>
                            <div class="input-group">
                                <div class="input-with-label"><span>M</span> <input type="number" id="duck_male" min="0" max="50" value="0"></div>
                                <div class="input-with-label"><span>F</span> <input type="number" id="duck_female" min="0" max="50" value="0"></div>
                            </div>
                        </div>
                        <div class="animal-item">
                            <label>Cat</label>
                            <div class="input-group">
                                <div class="input-with-label"><span>M</span> <input type="number" id="cat_male" min="0" max="50" value="0"></div>
                                <div class="input-with-label"><span>F</span> <input type="number" id="cat_female" min="0" max="50" value="0"></div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

      
        <div class="save-btn-container">
            <button class="save-btn" onclick="saveInformation()">Save Information</button>
        </div>
        
    </div>

    <script>
   
    function goBack() {
        window.history.back();
    }

   
    async function saveInformation() {
        const getParam = (p) => new URLSearchParams(window.location.search).get(p);
        const barangayParam = getParam('barangay');
        const farmerId = getParam('farmerId');

        const numericFields = [
            "cattle_male","cattle_female","quail_male","quail_female",
            "carabao_male","carabao_female","turkey_male","turkey_female",
            "horse_male","horse_female","geese_male","geese_female",
            "goat_male","goat_female","dove_male","dove_female",
            "sheep_male","sheep_female","dog_male","dog_female",
            "swine_male","swine_female","guinea_fowl_male","guinea_fowl_female",
            "chicken_male","chicken_female","game_fowl_male","game_fowl_female",
            "duck_male","duck_female","cat_male","cat_female"
        ];

       
        const farmerName = document.getElementById("farmerName")?.value?.trim() || null;
        const contact = document.getElementById("contact")?.value?.trim() || null;
        const ageRaw = document.getElementById("age")?.value;
        const sex = document.getElementById("sex")?.value || null;

      
        if (!farmerName) {
            alert("Please enter Farmer's Name.");
            return;
        }

        if (!contact) {
            alert("Please enter Contact.");
            return;
        }

        if (ageRaw === "" || ageRaw == null) {
            alert("Please enter Age.");
            return;
        }

        const ageNumber = parseInt(ageRaw, 10);
        if (!Number.isInteger(ageNumber) || ageNumber < 0) {
            alert("Please enter a valid age.");
            return;
        }

        if (!sex) {
            alert("Please select Sex.");
            return;
        }

      
        const payload = {
            farmerName: farmerName,
            contact: contact,
            age: ageNumber,
            sex: sex,
        };

        numericFields.forEach(id => {
            const el = document.getElementById(id);
            if (!el) {
                payload[id] = 0;
                return;
            }
            const raw = el.value;
            const n = (raw === "" || raw == null) ? 0 : parseInt(raw, 10);
            payload[id] = Number.isNaN(n) ? 0 : n;
        });

        if (barangayParam) payload.barangay = barangayParam;

        try {
            let resp;

            if (farmerId) {
                const barangayForPath = barangayParam || (payload.barangay ? payload.barangay : 'anao');
                resp = await fetch(`/api/livestock/${encodeURIComponent(barangayForPath)}/${encodeURIComponent(farmerId)}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
            } else {
                const barangayForPath = barangayParam || (payload.barangay ? payload.barangay : 'anao');
                resp = await fetch(`/api/livestock/${encodeURIComponent(barangayForPath)}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!resp.ok) {
                    console.warn('POST to /api/livestock/{barangay} returned', resp.status, '- trying /api/livestock/save fallback');
                    resp = await fetch(`/api/livestock/save`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                }
            }

            const text = await resp.text().catch(()=>null);

            if (resp.ok) {
                console.log('Save response OK:', resp.status, text);
                alert('Information saved successfully!');
                const redirectBarangay = payload.barangay || barangayParam || 'anao';
                window.location.href = `Livestock_Overview.html?barangay=${encodeURIComponent(redirectBarangay)}`;
            } else {
                console.error('Save failed:', resp.status, text);
                alert(`Failed to save. Server returned ${resp.status}: ${text || '(no message)'}`);
            }
        } catch (err) {
            console.error('Exception saving livestock:', err);
            alert('Failed to save (network or server error). See console for details.');
        }
    }
    </script>
</body>
</html>