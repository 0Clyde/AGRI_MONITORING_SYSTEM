<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Farmer Livestock</title>
    <link rel="stylesheet" href="Livestock_edit.css">
    
</head>
<body>

<div class="page-header">
    <h1>Livestock Edit</h1>
    
    <button class="back-btn" onclick="goBack()">‚Üê Back to Details</button>
</div>

    
    <h1>Edit Farmer Livestock</h1>

    
    <div class="farmer-info-readonly">
        <h2>Farmer Information</h2>
        <div class="info-grid">
            <div class="info-item">
                <label>Name:</label>
                <span id="farmerName">‚Äî</span>
            </div>
            <div class="info-item">
                <label>Contact:</label>
                <span id="farmerContact">‚Äî</span>
            </div>
            <div class="info-item">
                <label>Age:</label>
                <span id="farmerAge">‚Äî</span>
            </div>
            <div class="info-item">
                <label>Sex:</label>
                <span id="farmerSex">‚Äî</span>
            </div>
            <div class="info-item">
                <label>Barangay:</label>
                <span id="farmerBarangay">‚Äî</span>
            </div>
            <div class="info-item">
                <label>Farmer ID:</label>
                <span id="farmerId">‚Äî</span>
            </div>
        </div>
    </div>

    <div class="livestock-edit-section">
        <h2>Livestock Details</h2>
        <p style="color: #666;">Edit existing livestock or add new animal types below.</p>
        
        <table class="livestock-edit-table">
            <thead>
                <tr>
                    <th>Animal Type</th>
                    <th>Male Count</th>
                    <th>Female Count</th>
                    <th>Total</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="livestockEditBody">
                
            </tbody>
        </table>

        <button class="add-livestock-btn" onclick="addNewLivestockRow()">+ Add Animal Type</button>

        <div class="action-buttons">
            <button class="btn-cancel" onclick="cancelEdit()">Cancel</button>
            <button class="btn-save" onclick="saveChanges()">Save Changes</button>
        </div>
    </div>
</div>

<script>
let currentFarmer = null;
let livestockRows = [];


const animalTypes = [
    "Cattle", "Carabao", "Horse", "Goat", "Sheep", "Swine",
    "Chicken", "Duck", "Quail", "Turkey", "Geese", "Dove",
    "Ostrich", "Guinea Fowl", "Game Fowl", "Rabbit", "Dog", "Cat"
];


const animalFieldMap = {
    "Cattle": { male: "cattle_male", female: "cattle_female" },
    "Carabao": { male: "carabao_male", female: "carabao_female" },
    "Horse": { male: "horse_male", female: "horse_female" },
    "Goat": { male: "goat_male", female: "goat_female" },
    "Sheep": { male: "sheep_male", female: "sheep_female" },
    "Swine": { male: "swine_male", female: "swine_female" },
    "Chicken": { male: "chicken_male", female: "chicken_female" },
    "Duck": { male: "duck_male", female: "duck_female" },
    "Quail": { male: "quail_male", female: "quail_female" },
    "Turkey": { male: "turkey_male", female: "turkey_female" },
    "Geese": { male: "geese_male", female: "geese_female" },
    "Dove": { male: "dove_male", female: "dove_female" },
    "Ostrich": { male: "ostrich_male", female: "ostrich_female" },
    "Guinea Fowl": { male: "guinea_fowl_male", female: "guinea_fowl_female" },
    "Game Fowl": { male: "game_fowl_male", female: "game_fowl_female" },
    "Rabbit": { male: "rabbit_male", female: "rabbit_female" },
    "Dog": { male: "dog_male", female: "dog_female" },
    "Cat": { male: "cat_male", female: "cat_female" }
};

function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
}

function goBack() {
    const barangay = getQueryParam("barangay");
    const farmerId = getQueryParam("farmerId");
    window.location.href = `farmerslivestock_info.html?barangay=${barangay}&farmerId=${farmerId}`;
}

function cancelEdit() {
    if (confirm("Are you sure you want to cancel? All unsaved changes will be lost.")) {
        goBack();
    }
}

document.addEventListener("DOMContentLoaded", async () => {
    const barangay = getQueryParam("barangay");
    const farmerId = getQueryParam("farmerId");
    
    if (!barangay || !farmerId) {
        alert("Missing barangay or farmer ID!");
        return;
    }
    
    await loadFarmerData(barangay, farmerId);
});

async function loadFarmerData(barangay, farmerId) {
    try {
        const response = await fetch(`/api/livestock/${barangay}/${farmerId}`);
        if (!response.ok) {
            throw new Error("Failed to load farmer data");
        }

        currentFarmer = await response.json();
        console.log("Loaded farmer:", currentFarmer);

        
        document.getElementById("farmerName").textContent = currentFarmer.farmerName || "N/A";
        document.getElementById("farmerContact").textContent = currentFarmer.contact || "N/A";
        document.getElementById("farmerAge").textContent = currentFarmer.age || "N/A";
        document.getElementById("farmerSex").textContent = currentFarmer.sex || "N/A";
        document.getElementById("farmerBarangay").textContent = currentFarmer.barangay || "N/A";
        document.getElementById("farmerId").textContent = currentFarmer.id || "N/A";

        
        loadExistingLivestock();

    } catch (err) {
        console.error("Error loading farmer:", err);
        alert("Error loading farmer data: " + err.message);
    }
}

function loadExistingLivestock() {
    livestockRows = [];
    
   
    animalTypes.forEach(animalName => {
        const fields = animalFieldMap[animalName];
        const maleCount = currentFarmer[fields.male] || 0;
        const femaleCount = currentFarmer[fields.female] || 0;
        
        if (maleCount > 0 || femaleCount > 0) {
            livestockRows.push({
                animalType: animalName,
                male: maleCount,
                female: femaleCount
            });
        }
    });

    renderLivestockRows();
}

function renderLivestockRows() {
    const tbody = document.getElementById("livestockEditBody");
    tbody.innerHTML = "";

    if (livestockRows.length === 0) {
        tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; color:#666;">No livestock yet. Click "Add Animal Type" to add animals.</td></tr>`;
        return;
    }

    livestockRows.forEach((row, index) => {
        const tr = document.createElement("tr");
        
        const total = (parseInt(row.male) || 0) + (parseInt(row.female) || 0);
        
        tr.innerHTML = `
            <td>
                <select onchange="updateRowAnimalType(${index}, this.value)" ${livestockRows.filter(r => r.animalType === row.animalType).length > 0 ? '' : ''}>
                    ${animalTypes.map(animal => 
                        `<option value="${animal}" ${animal === row.animalType ? 'selected' : ''}>${animal}</option>`
                    ).join('')}
                </select>
            </td>
            <td>
                <input type="number" min="0" value="${row.male}" onchange="updateRowMale(${index}, this.value)">
            </td>
            <td>
                <input type="number" min="0" value="${row.female}" onchange="updateRowFemale(${index}, this.value)">
            </td>
            <td><strong>${total}</strong></td>
            <td>
                <button class="delete-row-btn" onclick="deleteRow(${index})">üóëÔ∏è Delete</button>
            </td>
        `;
        
        tbody.appendChild(tr);
    });
}

function updateRowAnimalType(index, value) {
    livestockRows[index].animalType = value;
    renderLivestockRows();
}

function updateRowMale(index, value) {
    livestockRows[index].male = parseInt(value) || 0;
    renderLivestockRows();
}

function updateRowFemale(index, value) {
    livestockRows[index].female = parseInt(value) || 0;
    renderLivestockRows();
}

function deleteRow(index) {
    if (confirm("Are you sure you want to delete this animal type?")) {
        livestockRows.splice(index, 1);
        renderLivestockRows();
    }
}

function addNewLivestockRow() {
    
    const usedAnimals = livestockRows.map(r => r.animalType);
    const availableAnimal = animalTypes.find(a => !usedAnimals.includes(a));
    
    if (!availableAnimal) {
        alert("All animal types have been added!");
        return;
    }
    
    livestockRows.push({
        animalType: availableAnimal,
        male: 0,
        female: 0
    });
    
    renderLivestockRows();
}

async function saveChanges() {
    const barangay = getQueryParam("barangay");
    const farmerId = getQueryParam("farmerId");

    
    const payload = {
        farmerName: currentFarmer.farmerName,
        contact: currentFarmer.contact,
        age: currentFarmer.age,
        sex: currentFarmer.sex,
        barangay: currentFarmer.barangay
    };

    
    animalTypes.forEach(animalName => {
        const fields = animalFieldMap[animalName];
        payload[fields.male] = 0;
        payload[fields.female] = 0;
    });

    
    livestockRows.forEach(row => {
        const fields = animalFieldMap[row.animalType];
        payload[fields.male] = parseInt(row.male) || 0;
        payload[fields.female] = parseInt(row.female) || 0;
    });

    console.log("Saving payload:", payload);

    try {
        const response = await fetch(`/api/livestock/${barangay}/${farmerId}`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            throw new Error("Failed to save changes");
        }

        alert("Livestock information updated successfully!");
        window.location.href = `farmerslivestock_info.html?barangay=${barangay}&farmerId=${farmerId}`;

    } catch (err) {
        console.error("Error saving:", err);
        alert("Error saving changes: " + err.message);
    }
}
</script>

</body>
</html>