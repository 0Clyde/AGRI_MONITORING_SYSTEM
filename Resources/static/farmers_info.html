<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Farmer Information</title>
    <link rel="stylesheet" href="farmers_info.css">
</head>
<body>
    <div class="container">
        <h2>Farmer Information</h2>

        <div class="form-container">
            
            <div class="left-panel">
                <label>Farmer Name:</label>
                <input type="text" id="farmerName" disabled>

                <label>Contact:</label>
                <input type="text" id="contact" disabled>

                <label>Age:</label>
                <input type="number" id="age" disabled>

                <label>Sex:</label>
                <input type="text" id="sex" disabled>
            </div>

            
            <div class="right-panel">
                <h3>High Value Data</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Crop</th>
                            <th>Area (ha)</th>
                            <th>Harvest (kg)</th>
                            <th>Fertilizer Used</th>
                        </tr>
                    </thead>
                    <tbody id="cropTableBody"></tbody>
                </table>

                <label>Total Area Planted:</label>
                <input type="text" id="totalAreaPlanted" disabled>

                <label>Pesticide Used:</label>
                <input type="text" id="pesticideUsed" disabled>

                <label>Fertilizer Used:</label>
                <input type="text" id="fertilizerUsed" disabled>

                <label>Barangay:</label>
                <input type="text" id="barangay" disabled>

                <div class="btns">
                    <button id="editBtn">Edit</button>
                    <button id="saveBtn" style="display:none;">Save</button>
                    <button id="deleteBtn">Delete</button>
                    <a href="crops_overview.html" class="back">Back</a>
                </div>
            </div>
        </div>
    </div>

  <script>

document.addEventListener("DOMContentLoaded", async () => {
    const barangay = getQueryParam("barangay");
    const farmerId = getQueryParam("farmerId");

    if (!barangay || !farmerId) {
        alert("Missing barangay or farmer ID");
        window.history.back();
        return;
    }

    try {
        const response = await fetch(`/api/crops/${barangay}/${farmerId}`);
        if (!response.ok) {
            throw new Error("Failed to load farmer data");
        }
        
        const farmer = await response.json();
        
       
        document.getElementById("farmerName").value = farmer.farmerName || "";
        document.getElementById("contact").value = farmer.contact || "";
        document.getElementById("age").value = farmer.age || "";
        document.getElementById("sex").value = farmer.sex || "";

        
        document.getElementById("cornArea").value = farmer.cornArea || "";
        document.getElementById("cornHarvest").value = farmer.cornHarvest || "";
        document.getElementById("cornFertilizer").value = farmer.cornFertilizer || "";
       

        document.getElementById("totalAreaPlanted").value = farmer.totalAreaPlanted || "";
        document.getElementById("pesticideUsed").value = farmer.pesticideUsed || "";
        document.getElementById("fertilizerUsed").value = farmer.fertilizerUsed || "";
        
    } catch (error) {
        console.error("Error loading farmer data:", error);
        alert("Failed to load farmer data");
    }
});


document.getElementById("updateBtn").addEventListener("click", async () => {
    const barangay = getQueryParam("barangay");
    const farmerId = getQueryParam("farmerId");

    const cropData = {
        farmerName: document.getElementById("farmerName").value,
        contact: document.getElementById("contact").value,
        age: document.getElementById("age").value ? parseInt(document.getElementById("age").value) : null,
        sex: document.getElementById("sex").value,
        
       
        cornArea: document.getElementById("cornArea").value ? parseFloat(document.getElementById("cornArea").value) : null,
        cornHarvest: document.getElementById("cornHarvest").value ? parseFloat(document.getElementById("cornHarvest").value) : null,
        cornFertilizer: document.getElementById("cornFertilizer").value,
        

        totalAreaPlanted: document.getElementById("totalAreaPlanted").value ? parseFloat(document.getElementById("totalAreaPlanted").value) : null,
        pesticideUsed: document.getElementById("pesticideUsed").value,
        fertilizerUsed: document.getElementById("fertilizerUsed").value
    };

    try {
        const response = await fetch(`/api/crops/${barangay}/${farmerId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(cropData)
        });

        if (response.ok) {
            alert("Data updated successfully!");
            window.location.href = `Crops_Overview.html?barangay=${barangay}`;
        } else {
            const errorText = await response.text();
            alert("Failed to update data: " + errorText);
            console.error("Error response:", errorText);
        }
    } catch (error) {
        console.error("Error updating data:", error);
        alert("An error occurred while updating data.");
    }
});


document.getElementById("deleteBtn").addEventListener("click", async () => {
    const barangay = getQueryParam("barangay");
    const farmerId = getQueryParam("farmerId");

    if (!confirm("Are you sure you want to delete this farmer's information?")) {
        return;
    }

    try {
        const response = await fetch(`/api/crops/${barangay}/${farmerId}`, {
            method: "DELETE"
        });

        if (response.ok) {
            alert("Data deleted successfully!");
            window.location.href = `Crops_Overview.html?barangay=${barangay}`;
        } else {
            alert("Failed to delete data.");
        }
    } catch (error) {
        console.error("Error deleting data:", error);
        alert("An error occurred while deleting data.");
    }
});
</script>

</body>
</html>
