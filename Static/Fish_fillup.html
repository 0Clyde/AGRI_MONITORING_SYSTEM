<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Farmers Info</title>
    <link rel="stylesheet" href="Fish_Fillup.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>New Farmers Info</h1>
            <button class="back-btn" onclick="goBack()">Back</button>
        </div>

        <div class="form-container">
            <div class="left-section">
                <div class="profile-section">
                    <div class="profile-box">
                        <!-- Profile Picture or Info Box -->
                    </div>
                </div>

                <div class="form-group">
                    <label>Farmer's Name</label>
                    <input type="text" id="farmer_name" placeholder="Enter farmer name">
                </div>

                <div class="form-group">
                    <label>Contact</label>
                    <input type="text" id="contact" placeholder="Enter phone number">
                </div>

                <div class="form-group">
                    <label>Age</label>
                    <input type="text" id="age" placeholder="Enter age">
                </div>

                <div class="form-group">
                    <label>Sex</label>
                    <select id="sex">
                        <option value=""> </option>
                        <option value="M">Male</option>
                        <option value="F">Female</option>
                        <option value="O">Other</option>
                    </select>
                    
                </div>
            </div>

            <div class="right-section">
                <div class="aqua-header">Aqua Products Data</div>

                <div class="table-section">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Kind of Fish</th>
                                    <th>Number of Ponds</th>
                                    <th>Area (sq. meters)</th>
                                    <th>No. of Stocks</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Tilapia</td>
                                    <td><input type="number" id="tilapiaPonds" value="0"></td>
                                    <td><input type="number" id="tilapiaArea" value="0" oninput="calculateTotals()"></td>
                                    <td><input type="number" id="tilapiaStocks" value="0" oninput="calculateTotals()"></td>
                                </tr>
                                <tr>
                                    <td>Bangus</td>
                                    <td><input type="number" id="bangusPonds" value="0"></td>
                                    <td><input type="number" id="bangusArea" value="0" oninput="calculateTotals()"></td>
                                    <td><input type="number" id="bangusStocks" value="0" oninput="calculateTotals()"></td>
                                </tr>
                                <tr>
                                    <td>Catfish</td>
                                    <td><input type="number" id="catfishPonds" value="0"></td>
                                    <td><input type="number" id="catfishArea" value="0" oninput="calculateTotals()"></td>
                                    <td><input type="number" id="catfishStocks" value="0" oninput="calculateTotals()"></td>
                                </tr>
                                <tr>
                                    <td>Crawfish</td>
                                    <td><input type="number" id="crawfishPonds" value="0"></td>
                                    <td><input type="number" id="crawfishArea" value="0" oninput="calculateTotals()"></td>
                                    <td><input type="number" id="crawfishStocks" value="0" oninput="calculateTotals()"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div class="bottom-section">
                        <div class="bottom-left">
                            <div class="bottom-field">
                                <label>Total Pond Area</label>
                                <input type="text" id="totalPondArea" readonly>
                            </div>

                            <div class="bottom-field">
                                <label>Total Average Production</label>
                                <input type="text" id="avgProduction" readonly>
                            </div>

                            <div class="bottom-field">
                                <label>Total No. of Feeds Used</label>
                                <input type="text" id="totalFeeds" readonly>
                            </div>
                        </div>

                        <div class="bottom-right">
                            <div class="feeds-header"><h5>Number of Feeds:</h5></div>
                            <div class="feed-row">
                                <label><h5>Tilapia</h5></label>
                                <input type="number" id="tilapiaFeeds" value="0" oninput="calculateTotals()">
                            </div>

                            <div class="feed-row">
                                <label><h5>Bangus</h5></label>
                                <input type="number" id="bangusFeeds" value="0" oninput="calculateTotals()">
                            </div>

                            <div class="feed-row">
                                <label><h5>Catfish</h5></label>
                                <input type="number" id="catfishFeeds" value="0" oninput="calculateTotals()">
                            </div>

                            <div class="feed-row">
                                <label><h5>Crawfish</h5></label>
                                <input type="number" id="crawfishFeeds" value="0" oninput="calculateTotals()">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="save-btn-container">
            <button class="save-btn" id="saveFishBtn">Save Information</button>
        </div>
    </div>

<script>
// AUTO-CALCULATE TOTALS IN REAL-TIME
function calculateTotals() {
    // Calculate Total Pond Area
    const tilapiaArea = parseFloat(document.getElementById("tilapiaArea").value) || 0;
    const bangusArea = parseFloat(document.getElementById("bangusArea").value) || 0;
    const catfishArea = parseFloat(document.getElementById("catfishArea").value) || 0;
    const crawfishArea = parseFloat(document.getElementById("crawfishArea").value) || 0;
    
    const totalPondArea = tilapiaArea + bangusArea + catfishArea + crawfishArea;
    document.getElementById("totalPondArea").value = totalPondArea.toFixed(2);

    // Calculate Total Average Production (Stocks)
    const tilapiaStocks = parseInt(document.getElementById("tilapiaStocks").value) || 0;
    const bangusStocks = parseInt(document.getElementById("bangusStocks").value) || 0;
    const catfishStocks = parseInt(document.getElementById("catfishStocks").value) || 0;
    const crawfishStocks = parseInt(document.getElementById("crawfishStocks").value) || 0;
    
    const totalAvgProduction = tilapiaStocks + bangusStocks + catfishStocks + crawfishStocks;
    document.getElementById("avgProduction").value = totalAvgProduction;

    // Calculate Total Feeds Used
    const tilapiaFeeds = parseInt(document.getElementById("tilapiaFeeds").value) || 0;
    const bangusFeeds = parseInt(document.getElementById("bangusFeeds").value) || 0;
    const catfishFeeds = parseInt(document.getElementById("catfishFeeds").value) || 0;
    const crawfishFeeds = parseInt(document.getElementById("crawfishFeeds").value) || 0;
    
    const totalFeeds = tilapiaFeeds + bangusFeeds + catfishFeeds + crawfishFeeds;
    document.getElementById("totalFeeds").value = totalFeeds;
}

// Run calculation on page load
window.onload = function() {
    calculateTotals();
};

// Redirect to previous page on clicking Back
function goBack() {
    const barangay = getQueryParam("barangay") || "anao";
    window.location.href = `Fisheries_Tables.html?barangay=${encodeURIComponent(barangay)}`;
}

function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
}

// ===== VALIDATION FUNCTION =====
function validateForm() {
    const farmerName = document.getElementById("farmer_name").value.trim();
    const contact = document.getElementById("contact").value.trim();
    const age = document.getElementById("age").value.trim();
    const sex = document.getElementById("sex").value;

    let errors = [];

    // Check required fields
    if (!farmerName) {
        errors.push("Farmer's Name is required");
    }

    if (!contact) {
        errors.push("Contact is required");
    } else if (!/^[0-9]{10,11}$/.test(contact)) {
        errors.push("Contact must be 10-11 digits");
    }

    if (!age) {
        errors.push("Age is required");
    } else {
        const ageNum = parseInt(age);
        if (isNaN(ageNum) || ageNum < 18 || ageNum > 100) {
            errors.push("Age must be between 18 and 100");
        }
    }

    if (!sex) {
        errors.push("Sex is required");
    }

    if (errors.length > 0) {
        alert("Please fix the following errors:\n\n" + errors.join("\n"));
        return false;
    }

    return true;
}

// Save the data when the Save button is clicked
document.getElementById("saveFishBtn").addEventListener("click", async () => {
    // ===== VALIDATE FORM FIRST =====
    if (!validateForm()) {
        return; // Stop if validation fails
    }

    const barangay = getQueryParam("barangay") || "anao";

    const fishData = {
        farmerName: document.getElementById("farmer_name").value.trim(),
        contact: document.getElementById("contact").value.trim(),
        age: parseInt(document.getElementById("age").value, 10),
        sex: document.getElementById("sex").value,

        tilapiaPonds: parseInt(document.getElementById("tilapiaPonds").value) || 0,
        tilapiaArea: parseFloat(document.getElementById("tilapiaArea").value) || 0,
        tilapiaStocks: parseInt(document.getElementById("tilapiaStocks").value) || 0,

        bangusPonds: parseInt(document.getElementById("bangusPonds").value) || 0,
        bangusArea: parseFloat(document.getElementById("bangusArea").value) || 0,
        bangusStocks: parseInt(document.getElementById("bangusStocks").value) || 0,

        hitoPonds: parseInt(document.getElementById("catfishPonds").value) || 0,
        hitoArea: parseFloat(document.getElementById("catfishArea").value) || 0,
        hitoStocks: parseInt(document.getElementById("catfishStocks").value) || 0,

        crawfishPonds: parseInt(document.getElementById("crawfishPonds").value) || 0,
        crawfishArea: parseFloat(document.getElementById("crawfishArea").value) || 0,
        crawfishStocks: parseInt(document.getElementById("crawfishStocks").value) || 0,

        totalPondArea: parseFloat(document.getElementById("totalPondArea").value) || 0,
        totalAvgProduction: parseInt(document.getElementById("avgProduction").value) || 0,
        totalFeedsUsed: parseInt(document.getElementById("totalFeeds").value) || 0,

        tilapiaFeeds: parseInt(document.getElementById("tilapiaFeeds").value) || 0,
        bangusFeeds: parseInt(document.getElementById("bangusFeeds").value) || 0,
        catfishFeeds: parseInt(document.getElementById("catfishFeeds").value) || 0,
        crawfishFeeds: parseInt(document.getElementById("crawfishFeeds").value) || 0,

        barangay: (barangay || "").trim().toLowerCase().replace(/\s+/g, "_")
    };

    try {
        const response = await fetch(`/api/fisheries/fish/${barangay}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(fishData)
        });

        if (response.ok) {
            alert("Data saved successfully!");
            window.location.href = `Fisheries_Overview.html?barangay=${encodeURIComponent(barangay)}`;
        } else {
            const errorData = await response.text();
            
            // Try to parse if it's JSON (validation errors)
            try {
                const errorJson = JSON.parse(errorData);
                let errorMessages = [];
                for (let field in errorJson) {
                    errorMessages.push(`${field}: ${errorJson[field]}`);
                }
                alert("Validation errors:\n\n" + errorMessages.join("\n"));
            } catch {
                // If not JSON, show as text
                alert("Failed to save data: " + errorData);
            }
        }
    } catch (error) {
        console.error("Error saving data:", error);
        alert("An error occurred while saving data.");
    }
});
</script>

</body>
</html>