<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profile - Agricultural System</title>
    
    <!-- CSS from static folder -->
    <link rel="stylesheet" href="Profile.css" />
</head>
<body>
    <div class="container">
        <!-- BACK BUTTON -->
        <button type="button" class="back-btn" onclick="goToInterface()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
            Back
        </button>

        <!-- PROFILE HEADER -->
        <div class="profile-header">
            <div class="profile-picture-container">
                <!-- Profile Picture with Camera Icon -->
                <div class="profile-picture" id="profilePicture">
                    <img id="profileImage" src="" alt="Profile" style="display: none; width: 100%; height: 100%; object-fit: cover; border-radius: 50%;" />
                    <svg id="defaultAvatar" viewBox="0 0 24 24">
                        <circle cx="12" cy="8" r="4" />
                        <path d="M4 20c0-4 4-6 8-6s8 2 8 6" />
                    </svg>
                </div>
                
                <!-- Camera Icon Button (only visible in edit mode) -->
                <button type="button" class="camera-btn" id="cameraBtn" onclick="triggerFileInput()" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                        <circle cx="12" cy="13" r="4"></circle>
                    </svg>
                </button>
                
                <!-- Hidden file input -->
                <input type="file" id="profileImageInput" accept="image/*" style="display: none;" onchange="handleImageUpload(event)" />
            </div>
            
            <div class="profile-name" id="displayName">Username</div>
            
            <!-- EDIT BUTTON -->
            <button type="button" class="edit-profile-btn" id="editProfileBtn" onclick="enableEditMode()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                </svg>
                Edit Profile
            </button>
        </div>

        <!-- PROFILE CONTENT -->
        <div class="profile-content">
            <form id="profileForm">
                
                <!-- PERSONAL INFORMATION -->
                <div class="form-section">
                    <h2 class="section-title">Personal Information</h2>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="firstName">First Name</label>
                            <div class="input-wrapper">
                                <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <circle cx="12" cy="8" r="4" />
                                    <path d="M4 20c0-4 4-6 8-6s8 2 8 6" />
                                </svg>
                                <input type="text" id="firstName" name="firstName" required placeholder="Enter first name" readonly />
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="lastName">Last Name</label>
                            <div class="input-wrapper">
                                <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                    <circle cx="12" cy="8" r="4" />
                                    <path d="M4 20c0-4 4-6 8-6s8 2 8 6" />
                                </svg>
                                <input type="text" id="lastName" name="lastName" required placeholder="Enter last name" readonly />
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="username">Username</label>
                        <div class="input-wrapper">
                            <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                            <input type="text" id="username" name="username" required placeholder="Enter username" readonly />
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="email">Email Address</label>
                        <div class="input-wrapper">
                            <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <rect x="3" y="5" width="18" height="14" rx="2"/>
                                <path d="M3 7l9 6 9-6"/>
                            </svg>
                            <input type="email" id="email" name="email" required placeholder="Enter email address" readonly />
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="password">Password</label>
                        <div class="input-wrapper">
                            <svg class="input-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <rect x="5" y="11" width="14" height="10" rx="2" />
                                <path d="M8 11V7a4 4 0 018 0v4" />
                            </svg>
                            <input type="password" id="password" name="password" value="••••••••" readonly />
                            <svg class="password-toggle" onclick="togglePasswordView()" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7z" />
                                <circle cx="12" cy="12" r="3" />
                            </svg>
                        </div>
                    </div>
                </div>

                <!-- ACTION BUTTONS (Hidden by default) -->
                <div class="button-group" id="actionButtons" style="display: none;">
                    <button type="button" class="btn btn-secondary" onclick="cancelEdit()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>

            </form>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // Store original values for cancel functionality
        let originalValues = {};
        let actualPassword = '';
        let originalProfileImage = ''; // Store original profile image
        let currentProfileImage = ''; // Current profile image (for editing)

        // Load user data from session on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadUserProfile();
        });

        // Load user profile from backend
        async function loadUserProfile() {
            try {
                const response = await fetch('/api/user/profile');
                if (response.ok) {
                    const user = await response.json();
                    
                    // Populate form fields
                    document.getElementById('firstName').value = user.firstName || '';
                    document.getElementById('lastName').value = user.lastName || '';
                    document.getElementById('username').value = user.username || '';
                    document.getElementById('email').value = user.email || '';
                    
                    // Set display name
                    document.getElementById('displayName').textContent = user.username || 'Username';
                    
                    // Load profile image if exists
                    if (user.profileImage) {
                        displayProfileImage(user.profileImage);
                        originalProfileImage = user.profileImage;
                        currentProfileImage = user.profileImage;
                    }
                    
                    // Store actual password
                    actualPassword = user.password || '••••••••';
                    document.getElementById('password').value = '••••••••';
                    
                    // Store original values
                    storeOriginalValues();
                } else {
                    console.error('Failed to load user profile');
                    if (response.status === 401) {
                        alert('Please login to view profile');
                        window.location.href = '/Login.html';
                    }
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        }

        // Store original form values
        function storeOriginalValues() {
            originalValues = {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                username: document.getElementById('username').value,
                email: document.getElementById('email').value
            };
        }

        // Trigger file input click
        function triggerFileInput() {
            document.getElementById('profileImageInput').click();
        }

        // Handle image upload
        function handleImageUpload(event) {
            const file = event.target.files[0];
            
            if (file) {
                // Validate file type
                if (!file.type.startsWith('image/')) {
                    alert('Please select a valid image file');
                    return;
                }
                
                // Validate file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('Image size should be less than 5MB');
                    return;
                }
                
                // Read and display image
                const reader = new FileReader();
                reader.onload = function(e) {
                    currentProfileImage = e.target.result;
                    displayProfileImage(currentProfileImage);
                };
                reader.readAsDataURL(file);
            }
        }

        // Display profile image
        function displayProfileImage(imageSrc) {
            const profileImage = document.getElementById('profileImage');
            const defaultAvatar = document.getElementById('defaultAvatar');
            
            if (imageSrc) {
                profileImage.src = imageSrc;
                profileImage.style.display = 'block';
                defaultAvatar.style.display = 'none';
            } else {
                profileImage.style.display = 'none';
                defaultAvatar.style.display = 'block';
            }
        }

        // Enable Edit Mode
        function enableEditMode() {
            // Remove readonly from editable fields
            document.getElementById('firstName').removeAttribute('readonly');
            document.getElementById('lastName').removeAttribute('readonly');
            document.getElementById('username').removeAttribute('readonly');
            document.getElementById('email').removeAttribute('readonly');
            
            // Show camera button for image upload
            document.getElementById('cameraBtn').style.display = 'flex';
            
            // Hide edit button
            document.getElementById('editProfileBtn').style.display = 'none';
            
            // Show action buttons
            document.getElementById('actionButtons').style.display = 'flex';
        }

        // Cancel Edit Mode
        function cancelEdit() {
            const confirmed = confirm('Are you sure you want to cancel? All unsaved changes will be lost.');
            
            if (confirmed) {
                // Restore original values
                document.getElementById('firstName').value = originalValues.firstName;
                document.getElementById('lastName').value = originalValues.lastName;
                document.getElementById('username').value = originalValues.username;
                document.getElementById('email').value = originalValues.email;
                
                // Restore original profile image
                currentProfileImage = originalProfileImage;
                displayProfileImage(originalProfileImage);
                
                // Reset password
                document.getElementById('password').type = 'password';
                document.getElementById('password').value = '••••••••';
                
                // Reset display name
                document.getElementById('displayName').textContent = originalValues.username || 'Username';
                
                // Clear file input
                document.getElementById('profileImageInput').value = '';
                
                // Disable edit mode
                disableEditMode();
            }
        }

        // Disable Edit Mode
        function disableEditMode() {
            // Set readonly
            document.getElementById('firstName').setAttribute('readonly', 'true');
            document.getElementById('lastName').setAttribute('readonly', 'true');
            document.getElementById('username').setAttribute('readonly', 'true');
            document.getElementById('email').setAttribute('readonly', 'true');
            
            // Hide camera button
            document.getElementById('cameraBtn').style.display = 'none';
            
            // Show edit button
            document.getElementById('editProfileBtn').style.display = 'inline-flex';
            
            // Hide action buttons
            document.getElementById('actionButtons').style.display = 'none';
        }

        // Toggle password visibility
        function togglePasswordView() {
            const passwordField = document.getElementById('password');
            const toggle = passwordField.parentElement.querySelector('.password-toggle');
            
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                toggle.innerHTML = `
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                    <path d="M17.94 17.94L4.06 4.06M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24"/>
                `;
            } else {
                passwordField.type = 'password';
                toggle.innerHTML = `
                    <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7z" />
                    <circle cx="12" cy="12" r="3" />
                `;
            }
        }

        // Form validation and submission
        document.getElementById('profileForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Get form values
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = document.getElementById('lastName').value.trim();
            const username = document.getElementById('username').value.trim();
            const email = document.getElementById('email').value.trim();
            
            // Basic validation
            if (!firstName || !lastName) {
                alert('First name and last name are required');
                return;
            }
            
            if (!username) {
                alert('Username is required');
                return;
            }
            
            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Please enter a valid email address');
                return;
            }
            
            // Prepare data
            const profileData = {
                firstName: firstName,
                lastName: lastName,
                username: username,
                email: email,
                profileImage: currentProfileImage // Include profile image
            };
            
            // Confirm before saving
            if (confirm('Are you sure you want to save these changes?')) {
                try {
                    // Send to backend
                    const response = await fetch('/api/user/profile', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(profileData)
                    });
                    
                    if (response.ok) {
                        alert('Profile updated successfully!');
                        
                        // Update display name
                        document.getElementById('displayName').textContent = username;
                        
                        // Update original profile image
                        originalProfileImage = currentProfileImage;
                        
                        // Store new values as original
                        storeOriginalValues();
                        
                        // Clear file input
                        document.getElementById('profileImageInput').value = '';
                        
                        // Disable edit mode
                        disableEditMode();
                    } else {
                        const error = await response.json();
                        alert(error.message || 'Failed to update profile');
                    }
                } catch (error) {
                    console.error('Error updating profile:', error);
                    alert('Network error. Please try again.');
                }
            }
        });

        // Go to Interface page
        function goToInterface() {
            window.location.href = '/Interface.html';
        }
    </script>
</body>
</html>