<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fisheries - Farmers Overview</title>
    <link rel="stylesheet" href="Fisheries_Overview.css">

</head>
<body>

<header class="header">
    <button class="back-btn" onclick="goToFisheries_Tables()">‚Üê</button>
    <h1 class="title">Fisheries - Farmers Overview</h1>
    <button class="add-btn" id="addNewBtn">Add New</button>
</header>

<main class="main-container">
    <aside class="farmers-panel">
        <div class="panel-header">Name of Farmers</div>
        
        <!-- Search Box -->
        <div class="search-container">
            <input 
                type="text" 
                id="searchBox" 
                class="search-box" 
                placeholder="üîç Search farmer by name..."
                onkeyup="searchFarmers()"
            >
            <div id="searchResultsCount" class="search-results-count"></div>
        </div>

        <div id="farmersListContainer">
            <div id="farmersList"></div>
        </div>
    </aside>
</main>

<script>
let allFarmers = []; // Store all farmers for searching
let currentBarangay = "";

function goToFisheries_Tables() {
    const barangay = getQueryParam("barangay") || "anao";
    window.location.href = `Fisheries_Tables.html?barangay=${encodeURIComponent(barangay)}`;  
}

function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
}

document.addEventListener("DOMContentLoaded", async () => {
    currentBarangay = getQueryParam("barangay") || "anao";
    await loadFarmers(currentBarangay);
});

async function loadFarmers(barangay) {
    const farmersPanel = document.getElementById("farmersList");

    if (!farmersPanel) {
        console.error("Farmers list container not found!");
        alert("Farmers list container not found!");
        return;
    }

    try {
        console.log(`Fetching farmers for barangay: ${barangay}`);
        const response = await fetch(`/api/fisheries/${barangay}`);
        
        if (!response.ok) {
            throw new Error(`Failed to fetch farmers: ${response.statusText}`);
        }

        allFarmers = await response.json();
        console.log("Fetched fisheries:", allFarmers);

        displayFarmers(allFarmers);
        updateSearchCount(allFarmers.length, allFarmers.length);

    } catch (error) {
        console.error("Error fetching farmers:", error);
        alert("Error loading farmers: " + error.message);
        farmersPanel.innerHTML = "<p>An error occurred while fetching farmer data.</p>";
    }
}

function displayFarmers(farmers) {
    const farmersPanel = document.getElementById("farmersList");
    farmersPanel.innerHTML = '';

    if (!farmers || farmers.length === 0) {
        const empty = document.createElement("div");
        empty.classList.add("farmer-item");
        empty.textContent = "No data yet.";
        farmersPanel.appendChild(empty);
        return;
    }

    farmers.forEach(fishery => {
        const div = document.createElement("div");
        div.classList.add("farmer-item");

        const displayName = fishery.farmerName || fishery.farmer_name || "Unnamed Farmer";

        // Link to farmer details page
        const farmerLink = document.createElement("a");
        farmerLink.href = `farmersfisheries_info.html?barangay=${encodeURIComponent(currentBarangay)}&farmerId=${encodeURIComponent(fishery.id)}`;
        farmerLink.innerHTML = displayName; // Use innerHTML for highlight
        farmerLink.classList.add("farmer-link");

        // DELETE button
        const deleteBtn = document.createElement("button");
        deleteBtn.innerHTML = "üóëÔ∏è";
        deleteBtn.classList.add("delete-farmer-btn");
        deleteBtn.title = "Delete farmer";

        deleteBtn.addEventListener("click", async (e) => {
            e.preventDefault();
            e.stopPropagation();

            const confirmDelete = confirm(
                `Are you sure you want to delete farmer "${displayName}"?`
            );
            if (!confirmDelete) return;

            try {
                console.log(`Deleting farmer id=${fishery.id} in barangay=${currentBarangay}`);

                const resp = await fetch(`/api/fisheries/${currentBarangay}/${fishery.id}`, {
                    method: "DELETE",
                    headers: {
                        "X-Requested-With": "XMLHttpRequest"
                    }
                });

                if (!resp.ok) {
                    throw new Error(`Failed to delete farmer: ${resp.statusText}`);
                }

                alert("Farmer deleted successfully!");
                await loadFarmers(currentBarangay);
                
                // Clear search box after delete
                document.getElementById("searchBox").value = "";

            } catch (err) {
                console.error("Error deleting farmer:", err);
                alert("An error occurred while trying to delete this farmer.");
            }
        });

        div.appendChild(farmerLink);
        div.appendChild(deleteBtn);

        farmersPanel.appendChild(div);
    });
}

function searchFarmers() {
    const searchText = document.getElementById("searchBox").value.toLowerCase().trim();
    
    if (!searchText) {
        // Show all farmers if search is empty
        displayFarmers(allFarmers);
        updateSearchCount(allFarmers.length, allFarmers.length);
        return;
    }

    // Filter farmers by name
    const filtered = allFarmers.filter(farmer => {
        const farmerName = (farmer.farmerName || farmer.farmer_name || "").toLowerCase();
        return farmerName.includes(searchText);
    });

    // Display filtered results with highlight
    displayFarmersWithHighlight(filtered, searchText);
    updateSearchCount(filtered.length, allFarmers.length);
}

function displayFarmersWithHighlight(farmers, searchText) {
    const farmersPanel = document.getElementById("farmersList");
    farmersPanel.innerHTML = '';

    if (!farmers || farmers.length === 0) {
        const empty = document.createElement("div");
        empty.classList.add("farmer-item");
        empty.textContent = "No farmers found matching your search.";
        empty.style.color = "#666";
        farmersPanel.appendChild(empty);
        return;
    }

    farmers.forEach(fishery => {
        const div = document.createElement("div");
        div.classList.add("farmer-item");

        const displayName = fishery.farmerName || fishery.farmer_name || "Unnamed Farmer";
        
        // Highlight matched text
        const highlightedName = highlightText(displayName, searchText);

        // Link to farmer details page
        const farmerLink = document.createElement("a");
        farmerLink.href = `farmersfisheries_info.html?barangay=${encodeURIComponent(currentBarangay)}&farmerId=${encodeURIComponent(fishery.id)}`;
        farmerLink.innerHTML = highlightedName;
        farmerLink.classList.add("farmer-link");

        // DELETE button
        const deleteBtn = document.createElement("button");
        deleteBtn.innerHTML = "üóëÔ∏è";
        deleteBtn.classList.add("delete-farmer-btn");
        deleteBtn.title = "Delete farmer";

        deleteBtn.addEventListener("click", async (e) => {
            e.preventDefault();
            e.stopPropagation();

            const confirmDelete = confirm(
                `Are you sure you want to delete farmer "${displayName}"?`
            );
            if (!confirmDelete) return;

            try {
                const resp = await fetch(`/api/fisheries/${currentBarangay}/${fishery.id}`, {
                    method: "DELETE",
                    headers: {
                        "X-Requested-With": "XMLHttpRequest"
                    }
                });

                if (!resp.ok) {
                    throw new Error(`Failed to delete farmer: ${resp.statusText}`);
                }

                alert("Farmer deleted successfully!");
                await loadFarmers(currentBarangay);
                document.getElementById("searchBox").value = "";

            } catch (err) {
                console.error("Error deleting farmer:", err);
                alert("An error occurred while trying to delete this farmer.");
            }
        });

        div.appendChild(farmerLink);
        div.appendChild(deleteBtn);

        farmersPanel.appendChild(div);
    });
}

function highlightText(text, search) {
    if (!search) return text;
    
    const regex = new RegExp(`(${escapeRegex(search)})`, 'gi');
    return text.replace(regex, '<span class="highlight">$1</span>');
}

function escapeRegex(string) {
    return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

function updateSearchCount(found, total) {
    const countDiv = document.getElementById("searchResultsCount");
    if (found === total) {
        countDiv.textContent = `Showing all ${total} farmer${total !== 1 ? 's' : ''}`;
    } else {
        countDiv.textContent = `Found ${found} of ${total} farmer${total !== 1 ? 's' : ''}`;
    }
}

document.getElementById("addNewBtn").addEventListener("click", () => {
    const barangay = getQueryParam("barangay") || "anao";
    console.log("Redirecting to Fish_fillup.html with barangay:", barangay);
    window.location.href = `Fish_fillup.html?barangay=${encodeURIComponent(barangay)}`;
});
</script>

</body>
</html>