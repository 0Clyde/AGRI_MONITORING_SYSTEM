<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify Code</title>
    <link rel="stylesheet" href="Verificationcode.css">
    <style>
        /* Profile preview */
        #userProfilePreview {
            text-align: center;
            margin-bottom: 15px;
            display: none;
        }
        
        #userProfilePic {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 4px solid #7B4BA6;
            box-shadow: 0 4px 15px rgba(123, 75, 166, 0.3);
            background: #fff;
            margin: 0 auto 10px auto;
            display: block;
        }
        
        #userProfileName {
            color: #333;
            font-size: 14px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="form-box">
            <!-- USER PROFILE PREVIEW -->
            <div id="userProfilePreview">
                <img id="userProfilePic" src="" alt="Profile">
                <div id="userProfileName"></div>
            </div>
            
            <!-- DEFAULT USER ICON -->
            <div class="user-icon" id="defaultUserIcon">
                <svg width="80" height="80" viewBox="0 0 80 80" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="40" cy="40" r="38" fill="#E8D5F2" stroke="#7B4BA6" stroke-width="2"/>
                    <circle cx="40" cy="32" r="12" fill="none" stroke="#7B4BA6" stroke-width="3"/>
                    <path d="M 20 60 Q 40 45 60 60" fill="none" stroke="#7B4BA6" stroke-width="3"/>
                </svg>
            </div>
            
            <h1>Verify Code</h1>
            <p id="emailDisplay" style="color: #666; margin-bottom: 20px;"></p>
            
            <div id="messageBox" style="display:none; padding: 10px; margin-bottom: 15px; border-radius: 5px;"></div>
            
            <form id="verificationForm">
                <div class="form-group">
                    <label>Enter Verification Code</label>
                    <div class="input-wrapper">
                        <input type="text" id="verificationCode" placeholder="Enter 6-digit code" maxlength="6" required>
                    </div>
                </div>
                
                <button type="submit" class="create-btn">Verify</button>
            </form>
            
            <div style="text-align: center; margin-top: 15px;">
                <a href="#" id="resendLink" style="color: #7B4BA6; text-decoration: none;">Resend Code</a>
                <span style="margin: 0 10px; color: #ccc;">|</span>
                <a href="Forgotpassword.html" style="color: #7B4BA6; text-decoration: none;">Back</a>
            </div>
        </div>
    </div>
    
    <script>
        // Get email from URL parameter
        const urlParams = new URLSearchParams(window.location.search);
        const email = urlParams.get('email');

        // Display email
        if (email) {
            document.getElementById('emailDisplay').textContent = `Code sent to: ${email}`;
            
            // Load user profile
            loadUserProfile(email);
        } else {
            showMessage('Invalid access. Please start from the forgot password page.', 'error');
            setTimeout(() => {
                window.location.href = 'Forgotpassword.html';
            }, 3000);
        }
        
        async function loadUserProfile(email) {
            try {
                const response = await fetch(`/api/user/by-email?email=${encodeURIComponent(email)}`);
                if (response.ok) {
                    const userData = await response.json();
                    
                    if (userData.email) {
                        const picUrl = userData.profileImage || 
                            'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%237B4BA6"%3E%3Ccircle cx="12" cy="8" r="4"/%3E%3Cpath d="M4 20c0-4 4-6 8-6s8 2 8 6"/%3E%3C/svg%3E';
                        document.getElementById('userProfilePic').src = picUrl;
                        document.getElementById('userProfileName').textContent = userData.firstName;
                        document.getElementById('userProfilePreview').style.display = 'block';
                        document.getElementById('defaultUserIcon').style.display = 'none';
                    }
                }
            } catch (error) {
                console.log('Could not load profile');
            }
        }

        // Verification form submit
        document.getElementById('verificationForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const verificationCode = document.getElementById('verificationCode').value;

            // Validation
            if (verificationCode.length !== 6) {
                showMessage('Please enter a valid 6-digit code', 'error');
                return;
            }

            // Show loading state
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Verifying...';
            submitBtn.disabled = true;

            // Send POST request to verify the code
            fetch('/api/password/verify-code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    email: email, 
                    verificationCode: verificationCode 
                }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success || data === "Code verified successfully.") {
                    showMessage('Code verified! Redirecting...', 'success');
                    // Redirect to reset password page
                    setTimeout(() => {
                        window.location.href = `Resetpassword.html?email=${encodeURIComponent(email)}`;
                    }, 1500);
                } else {
                    showMessage(data.message || 'Invalid verification code. Please try again.', 'error');
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Network error. Please try again.', 'error');
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            });
        });

        // Resend code functionality
        document.getElementById('resendLink').addEventListener('click', function(e) {
            e.preventDefault();
            
            if (!email) {
                showMessage('Cannot resend code. Email not found.', 'error');
                return;
            }

            const resendLink = this;
            const originalText = resendLink.textContent;
            resendLink.textContent = 'Sending...';
            resendLink.style.pointerEvents = 'none';

            // Send request to resend verification code
            fetch('/api/password/resend-code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ email: email }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.success || data === "Verification code resent successfully.") {
                    showMessage('New code sent to your email!', 'success');
                    // Start cooldown timer (60 seconds)
                    startCooldown(resendLink, 60);
                } else {
                    showMessage(data.message || 'Failed to resend code. Please try again.', 'error');
                    resendLink.textContent = originalText;
                    resendLink.style.pointerEvents = 'auto';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showMessage('Network error. Please try again.', 'error');
                resendLink.textContent = originalText;
                resendLink.style.pointerEvents = 'auto';
            });
        });

        function startCooldown(element, seconds) {
            let remaining = seconds;
            const interval = setInterval(() => {
                element.textContent = `Resend Code (${remaining}s)`;
                remaining--;
                
                if (remaining < 0) {
                    clearInterval(interval);
                    element.textContent = 'Resend Code';
                    element.style.pointerEvents = 'auto';
                }
            }, 1000);
        }

        function showMessage(message, type) {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.style.display = 'block';
            messageBox.style.backgroundColor = type === 'success' ? '#d4edda' : '#f8d7da';
            messageBox.style.color = type === 'success' ? '#155724' : '#721c24';
            messageBox.style.border = type === 'success' ? '1px solid #c3e6cb' : '1px solid #f5c6cb';
        }

        // Auto-focus on verification code input
        document.getElementById('verificationCode').focus();
    </script>
</body>
</html>