<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Farmer Crops</title>
    <link rel="stylesheet" href="Crops_edit.css">
</head>
<body>

<div class="edit-mode-container">
    <!-- Page Header -->
    <header class="page-header">
        <h1>Edit Farmer Crops</h1>
        <button class="back-btn" onclick="goBack()">‚Üê Back to Details</button>
    </header>
    
    <!-- Farmer Info (Read-only) -->
    <section class="farmer-info-readonly">
        <h2>Farmer Information</h2>
        <div class="info-grid">
            <div class="info-item">
                <label>Name:</label>
                <span id="farmerName">‚Äî</span>
            </div>
            <div class="info-item">
                <label>Contact:</label>
                <span id="farmerContact">‚Äî</span>
            </div>
            <div class="info-item">
                <label>Age:</label>
                <span id="farmerAge">‚Äî</span>
            </div>
            <div class="info-item">
                <label>Sex:</label>
                <span id="farmerSex">‚Äî</span>
            </div>
            <div class="info-item">
                <label>Barangay:</label>
                <span id="farmerBarangay">‚Äî</span>
            </div>
            <div class="info-item">
                <label>Farmer ID:</label>
                <span id="farmerId">‚Äî</span>
            </div>
        </div>
    </section>

    <!-- Crops Edit Section -->
    <section class="crops-edit-section">
        <div class="section-header">
            <h2>Crops Management</h2>
            <p>Edit existing crops or add new crop types to the farmer's inventory.</p>
        </div>
        
        <div class="table-container">
            <table class="crops-edit-table">
                <thead>
                    <tr>
                        <th>Crop Type</th>
                        <th>Area (ha)</th>
                        <th>Harvest (kg)</th>
                        <th>Fertilizer Used</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="cropsEditBody">
                    <!-- Rows will be injected here by JavaScript -->
                </tbody>
            </table>
        </div>

        <button class="add-crop-btn" onclick="addNewCropRow()">Add Crop Type</button>

        <div class="action-buttons">
            <button class="btn-cancel" onclick="cancelEdit()">Cancel</button>
            <button class="btn-save" onclick="saveChanges()">Save Changes</button>
        </div>
    </section>
</div>

<script>
let currentFarmer = null;
let cropsRows = [];

// All available crop types (24 crops!)
const cropTypes = [
    "Corn", "Tomato", "Eggplant", "Bellpepper", "Squash", "Okra", 
    "Cucumber", "String Beans", "Sweetpotato", "Potato", "Spinach", 
    "Kangkong", "Carrots", "Ampalaya", "Malunggay", "Cassava", 
    "Cabbage", "Lettuce", "Baguio Beans", "Cauliflower", "Onion", 
    "Spring Onion", "Garlic", "Ginger"
];

// Map crop display names to database field names (snake_case)
const cropFieldMap = {
    "Corn": { area: "corn_area", harvest: "corn_harvest", fert: "corn_fertilizer" },
    "Tomato": { area: "tomato_area", harvest: "tomato_harvest", fert: "tomato_fertilizer" },
    "Eggplant": { area: "eggplant_area", harvest: "eggplant_harvest", fert: "eggplant_fertilizer" },
    "Bellpepper": { area: "bellpepper_area", harvest: "bellpepper_harvest", fert: "bellpepper_fertilizer" },
    "Squash": { area: "squash_area", harvest: "squash_harvest", fert: "squash_fertilizer" },
    "Okra": { area: "okra_area", harvest: "okra_harvest", fert: "okra_fertilizer" },
    "Cucumber": { area: "cucumber_area", harvest: "cucumber_harvest", fert: "cucumber_fertilizer" },
    "String Beans": { area: "stringbeans_area", harvest: "stringbeans_harvest", fert: "stringbeans_fertilizer" },
    "Sweetpotato": { area: "sweet_potatoes_area", harvest: "sweet_potatoes_harvest", fert: "sweet_potatoes_fertilizer" },
    "Potato": { area: "potato_area", harvest: "potato_harvest", fert: "potato_fertilizer" },
    "Spinach": { area: "spinach_area", harvest: "spinach_harvest", fert: "spinach_fertilizer" },
    "Kangkong": { area: "kangkong_area", harvest: "kangkong_harvest", fert: "kangkong_fertilizer" },
    "Carrots": { area: "carrots_area", harvest: "carrots_harvest", fert: "carrots_fertilizer" },
    "Ampalaya": { area: "ampalaya_area", harvest: "ampalaya_harvest", fert: "ampalaya_fertilizer" },
    "Malunggay": { area: "malunggay_area", harvest: "malunggay_harvest", fert: "malunggay_fertilizer" },
    "Cassava": { area: "cassava_area", harvest: "cassava_harvest", fert: "cassava_fertilizer" },
    "Cabbage": { area: "cabbage_area", harvest: "cabbage_harvest", fert: "cabbage_fertilizer" },
    "Lettuce": { area: "lettuce_area", harvest: "lettuce_harvest", fert: "lettuce_fertilizer" },
    "Baguio Beans": { area: "baguio_beans_area", harvest: "baguio_beans_harvest", fert: "baguio_beans_fertilizer" },
    "Cauliflower": { area: "cauliflower_area", harvest: "cauliflower_harvest", fert: "cauliflower_fertilizer" },
    "Onion": { area: "onion_area", harvest: "onion_harvest", fert: "onion_fertilizer" },
    "Spring Onion": { area: "spring_onion_area", harvest: "spring_onion_harvest", fert: "spring_onion_fertilizer" },
    "Garlic": { area: "garlic_area", harvest: "garlic_harvest", fert: "garlic_fertilizer" },
    "Ginger": { area: "ginger_area", harvest: "ginger_harvest", fert: "ginger_fertilizer" }
};

function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
}

function goBack() {
    const barangay = getQueryParam("barangay");
    const farmerId = getQueryParam("farmerId");
    window.location.href = `Farmer_details.html?barangay=${barangay}&farmerId=${farmerId}`;
}

function cancelEdit() {
    if (confirm("Are you sure you want to cancel? All unsaved changes will be lost.")) {
        goBack();
    }
}

document.addEventListener("DOMContentLoaded", async () => {
    const barangay = getQueryParam("barangay");
    const farmerId = getQueryParam("farmerId");
    
    if (!barangay || !farmerId) {
        alert("Missing barangay or farmer ID!");
        window.history.back();
        return;
    }
    
    await loadFarmerData(barangay, farmerId);
});

async function loadFarmerData(barangay, farmerId) {
    try {
        console.log(`Loading farmer data: ${barangay}/${farmerId}`);
        const response = await fetch(`/api/crops/${barangay}/${farmerId}`);
        
        if (!response.ok) {
            throw new Error(`Failed to load farmer data: ${response.statusText}`);
        }

        currentFarmer = await response.json();
        console.log("Loaded farmer:", currentFarmer);

        // Display farmer information
        document.getElementById("farmerName").textContent = currentFarmer.farmer_name || "N/A";
        document.getElementById("farmerContact").textContent = currentFarmer.contact || "N/A";
        document.getElementById("farmerAge").textContent = currentFarmer.age || "N/A";
        document.getElementById("farmerSex").textContent = currentFarmer.sex || "N/A";
        document.getElementById("farmerBarangay").textContent = currentFarmer.barangay || "N/A";
        document.getElementById("farmerId").textContent = currentFarmer.id || "N/A";

        // Load existing crops data
        loadExistingCrops();

    } catch (err) {
        console.error("Error loading farmer:", err);
        alert("Error loading farmer data: " + err.message);
        window.history.back();
    }
}

function loadExistingCrops() {
    cropsRows = [];
    
    // Load all existing crops with data
    cropTypes.forEach(cropName => {
        const fields = cropFieldMap[cropName];
        const area = currentFarmer[fields.area] || 0;
        const harvest = currentFarmer[fields.harvest] || 0;
        const fert = currentFarmer[fields.fert] || "";
        
        if (area > 0 || harvest > 0 || fert) {
            cropsRows.push({
                cropType: cropName,
                area: area,
                harvest: harvest,
                fertilizer: fert
            });
        }
    });

    renderCropsRows();
}

function renderCropsRows() {
    const tbody = document.getElementById("cropsEditBody");
    tbody.innerHTML = "";

    if (cropsRows.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="empty-state">
                    No crops yet. Click "Add Crop Type" to start adding crops.
                </td>
            </tr>`;
        return;
    }

    cropsRows.forEach((row, index) => {
        const tr = document.createElement("tr");
        
        tr.innerHTML = `
            <td>
                <select onchange="updateRowCropType(${index}, this.value)">
                    ${cropTypes.map(crop => 
                        `<option value="${crop}" ${crop === row.cropType ? 'selected' : ''}>${crop}</option>`
                    ).join('')}
                </select>
            </td>
            <td>
                <input type="number" min="0" step="0.01" value="${row.area}" onchange="updateRowArea(${index}, this.value)">
            </td>
            <td>
                <input type="number" min="0" step="0.01" value="${row.harvest}" onchange="updateRowHarvest(${index}, this.value)">
            </td>
            <td>
                <input type="text" value="${row.fertilizer}" onchange="updateRowFertilizer(${index}, this.value)">
            </td>
            <td>
                <button class="delete-row-btn" onclick="deleteRow(${index})">üóëÔ∏è Delete</button>
            </td>
        `;
        
        tbody.appendChild(tr);
    });
}

function updateRowCropType(index, value) {
    cropsRows[index].cropType = value;
    renderCropsRows();
}

function updateRowArea(index, value) {
    cropsRows[index].area = parseFloat(value) || 0;
    renderCropsRows();
}

function updateRowHarvest(index, value) {
    cropsRows[index].harvest = parseFloat(value) || 0;
    renderCropsRows();
}

function updateRowFertilizer(index, value) {
    cropsRows[index].fertilizer = value;
}

function deleteRow(index) {
    if (confirm(`Are you sure you want to delete ${cropsRows[index].cropType}?`)) {
        cropsRows.splice(index, 1);
        renderCropsRows();
    }
}

function addNewCropRow() {
    // Find first crop type not already in use
    const usedCrops = cropsRows.map(r => r.cropType);
    const availableCrop = cropTypes.find(c => !usedCrops.includes(c));
    
    if (!availableCrop) {
        alert("All crop types have been added!");
        return;
    }
    
    cropsRows.push({
        cropType: availableCrop,
        area: 0,
        harvest: 0,
        fertilizer: ""
    });
    
    renderCropsRows();
}

async function saveChanges() {
    const barangay = getQueryParam("barangay");
    const farmerId = getQueryParam("farmerId");

    // Build payload with all crop data
    const payload = {
        farmer_name: currentFarmer.farmer_name,
        contact: currentFarmer.contact,
        age: currentFarmer.age,
        sex: currentFarmer.sex,
        barangay: currentFarmer.barangay
    };

    // Initialize all crop fields to null/empty
    cropTypes.forEach(cropName => {
        const fields = cropFieldMap[cropName];
        payload[fields.area] = null;
        payload[fields.harvest] = null;
        payload[fields.fert] = "";
    });

    // Set values from edited rows
    cropsRows.forEach(row => {
        const fields = cropFieldMap[row.cropType];
        payload[fields.area] = parseFloat(row.area) || null;
        payload[fields.harvest] = parseFloat(row.harvest) || null;
        payload[fields.fert] = row.fertilizer || "";
    });

    // Keep existing summary fields
    payload.total_area_planted = currentFarmer.total_area_planted || null;
    payload.pesticide_used = currentFarmer.pesticide_used || "";
    payload.fertilizer_used = currentFarmer.fertilizer_used || "";

    console.log("Saving payload:", payload);

    try {
        const response = await fetch(`/api/crops/${barangay}/${farmerId}`, {
            method: "PUT",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Failed to save: ${errorText}`);
        }

        alert("Crops information updated successfully!");
        window.location.href = `Farmer_details.html?barangay=${barangay}&farmerId=${farmerId}`;

    } catch (err) {
        console.error("Error saving:", err);
        alert("Error saving changes: " + err.message);
    }
}
</script>

</body>
</html>