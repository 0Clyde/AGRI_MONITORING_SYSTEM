<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Farmers Info</title>
    <link rel="stylesheet" href="Crop_fillup.css">
</head>
<body>
<div class="container">
    <div class="header">
        <h1>New Farmers Info</h1>
        <button class="back-btn" onclick="window.history.back()">Back</button>
    </div>

    <div class="form-container">
        <div class="left-section">
            <div class="form-group">
                <label>Farmer Name</label>
                <input type="text" id="farmer_name" required placeholder="Enter farmer name">
            </div>
            <div class="form-group">
                <label>Contact</label>
                <input type="text" id="contact" placeholder="Enter phone number">
            </div>
            <div class="form-group">
                <label>Age</label>
                <input type="number" id="age" placeholder="Enter age">
            </div>
            <div class="form-group">
                <label for="sex">Sex</label>
                <select id="sex" onchange="toggleCustomInput()">
                    <option value=""></option>
                    <option value="M">Male</option>
                    <option value="F">Female</option>
                    <option value="O">Other</option>
                </select>
                <input type="text" id="customSex" placeholder="Please specify" style="display: none;" />
            </div>
        </div>

        <div class="right-section">
            <div class="high-value-header">High Value Data</div>
            <table>
                <thead>
                    <tr>
                        <th>Crop</th>
                        <th>Area (hectares)</th>
                        <th>Harvest (kg)</th>
                        <th>Fertilizer Used</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>Corn</td><td><input id="cornArea" type="number" step="0.01" value="0" oninput="calculateTotal()"></td><td><input id="cornHarvest" type="number" step="0.01" value="0"></td><td><input id="cornFertilizer" type="text"></td></tr>
                    <tr><td>Tomato</td><td><input id="tomatoArea" type="number" step="0.01" value="0" oninput="calculateTotal()"></td><td><input id="tomatoHarvest" type="number" step="0.01" value="0"></td><td><input id="tomatoFertilizer" type="text"></td></tr>
                    <tr><td>Eggplant</td><td><input id="eggplantArea" type="number" step="0.01" value="0" oninput="calculateTotal()"></td><td><input id="eggplantHarvest" type="number" step="0.01" value="0"></td><td><input id="eggplantFertilizer" type="text"></td></tr>
                    <tr><td>Bellpepper</td><td><input id="bellpepperArea" type="number" step="0.01" value="0" oninput="calculateTotal()"></td><td><input id="bellpepperHarvest" type="number" step="0.01" value="0"></td><td><input id="bellpepperFertilizer" type="text"></td></tr>
                    <tr><td>Squash</td><td><input id="squashArea" type="number" step="0.01" value="0" oninput="calculateTotal()"></td><td><input id="squashHarvest" type="number" step="0.01" value="0"></td><td><input id="squashFertilizer" type="text"></td></tr>
                    <tr><td>Okra</td><td><input id="okraArea" type="number" step="0.01" value="0" oninput="calculateTotal()"></td><td><input id="okraHarvest" type="number" step="0.01" value="0"></td><td><input id="okraFertilizer" type="text"></td></tr>
                    <tr><td>Cucumber</td><td><input id="cucumberArea" type="number" step="0.01" value="0" oninput="calculateTotal()"></td><td><input id="cucumberHarvest" type="number" step="0.01" value="0"></td><td><input id="cucumberFertilizer" type="text"></td></tr>
                    <tr><td>String Beans</td><td><input id="stringbeansArea" type="number" step="0.01" value="0" oninput="calculateTotal()"></td><td><input id="stringbeansHarvest" type="number" step="0.01" value="0"></td><td><input id="stringbeansFertilizer" type="text"></td></tr>
                    <tr><td>Sweetpotato</td><td><input id="sweetpotatoArea" type="number" step="0.01" value="0" oninput="calculateTotal()"></td><td><input id="sweetpotatoHarvest" type="number" step="0.01" value="0"></td><td><input id="sweetpotatoFertilizer" type="text"></td></tr>
                    <tr><td>Potato</td><td><input id="potatoArea" type="number" step="0.01" value="0" oninput="calculateTotal()"></td><td><input id="potatoHarvest" type="number" step="0.01" value="0"></td><td><input id="potatoFertilizer" type="text"></td></tr>
                    <tr><td>Spinach</td><td><input id="spinachArea" type="number" step="0.01" value="0" oninput="calculateTotal()"></td><td><input id="spinachHarvest" type="number" step="0.01" value="0"></td><td><input id="spinachFertilizer" type="text"></td></tr>
                    <tr><td>Kangkong</td><td><input id="kangkongArea" type="number" step="0.01" value="0" oninput="calculateTotal()"></td><td><input id="kangkongHarvest" type="number" step="0.01" value="0"></td><td><input id="kangkongFertilizer" type="text"></td></tr>
                    <tr><td>Carrots</td><td><input id="carrotsArea" type="number" step="0.01" value="0" oninput="calculateTotal()"></td><td><input id="carrotsHarvest" type="number" step="0.01" value="0"></td><td><input id="carrotsFertilizer" type="text"></td></tr>
                    <tr><td>Ampalaya</td><td><input id="ampalayaArea" type="number" step="0.01" value="0" oninput="calculateTotal()"></td><td><input id="ampalayaHarvest" type="number" step="0.01" value="0"></td><td><input id="ampalayaFertilizer" type="text"></td></tr>
                    <tr><td>Malunggay</td><td><input id="malunggayArea" type="number" step="0.01" value="0" oninput="calculateTotal()"></td><td><input id="malunggayHarvest" type="number" step="0.01" value="0"></td><td><input id="malunggayFertilizer" type="text"></td></tr>
                    <tr><td>Cassava</td><td><input id="cassavaArea" type="number" step="0.01" value="0" oninput="calculateTotal()"></td><td><input id="cassavaHarvest" type="number" step="0.01" value="0"></td><td><input id="cassavaFertilizer" type="text"></td></tr>
                    <tr><td>Cabbage</td><td><input id="cabbageArea" type="number" step="0.01" value="0" oninput="calculateTotal()"></td><td><input id="cabbageHarvest" type="number" step="0.01" value="0"></td><td><input id="cabbageFertilizer" type="text"></td></tr>
                    <tr><td>Lettuce</td><td><input id="lettuceArea" type="number" step="0.01" value="0" oninput="calculateTotal()"></td><td><input id="lettuceHarvest" type="number" step="0.01" value="0"></td><td><input id="lettuceFertilizer" type="text"></td></tr>
                    <tr><td>Baguio Beans</td><td><input id="baguiobeansArea" type="number" step="0.01" value="0" oninput="calculateTotal()"></td><td><input id="baguiobeansHarvest" type="number" step="0.01" value="0"></td><td><input id="baguiobeansFertilizer" type="text"></td></tr>
                    <tr><td>Cauliflower</td><td><input id="cauliflowerArea" type="number" step="0.01" value="0" oninput="calculateTotal()"></td><td><input id="cauliflowerHarvest" type="number" step="0.01" value="0"></td><td><input id="cauliflowerFertilizer" type="text"></td></tr>
                    <tr><td>Onion</td><td><input id="onionArea" type="number" step="0.01" value="0" oninput="calculateTotal()"></td><td><input id="onionHarvest" type="number" step="0.01" value="0"></td><td><input id="onionFertilizer" type="text"></td></tr>
                    <tr><td>Spring Onion</td><td><input id="springonionArea" type="number" step="0.01" value="0" oninput="calculateTotal()"></td><td><input id="springonionHarvest" type="number" step="0.01" value="0"></td><td><input id="springonionFertilizer" type="text"></td></tr>
                    <tr><td>Garlic</td><td><input id="garlicArea" type="number" step="0.01" value="0" oninput="calculateTotal()"></td><td><input id="garlicHarvest" type="number" step="0.01" value="0"></td><td><input id="garlicFertilizer" type="text"></td></tr>
                    <tr><td>Ginger</td><td><input id="gingerArea" type="number" step="0.01" value="0" oninput="calculateTotal()"></td><td><input id="gingerHarvest" type="number" step="0.01" value="0"></td><td><input id="gingerFertilizer" type="text"></td></tr>
                </tbody>
            </table>

            <div class="bottom-fields">
                <div class="bottom-field">
                    <label>Total Area Planted</label>
                    <input type="number" id="totalAreaPlanted" step="0.01" readonly>
                </div>
                <div class="bottom-field">
                    <label>Pesticide Use</label>
                    <input type="text" id="pesticideUsed" placeholder="Optional">
                </div>
                <div class="bottom-field">
                    <label>Fertilizer Used</label>
                    <input type="text" id="fertilizerUsed" placeholder="Optional">
                </div>
            </div>
        </div>
    </div>

    <div class="save-btn-container">
        <button class="save-btn" id="saveCropBtn">Save Information</button>
    </div>
</div>

<script>
// AUTO-CALCULATE TOTAL AREA PLANTED
function calculateTotal() {
    const areaIds = [
        "cornArea", "tomatoArea", "eggplantArea", "bellpepperArea", "squashArea",
        "okraArea", "cucumberArea", "stringbeansArea", "sweetpotatoArea", "potatoArea",
        "spinachArea", "kangkongArea", "carrotsArea", "ampalayaArea", "malunggayArea",
        "cassavaArea", "cabbageArea", "lettuceArea", "baguiobeansArea", "cauliflowerArea",
        "onionArea", "springonionArea", "garlicArea", "gingerArea"
    ];

    let total = 0;
    areaIds.forEach(id => {
        const value = parseFloat(document.getElementById(id).value) || 0;
        total += value;
    });

    document.getElementById("totalAreaPlanted").value = total.toFixed(2);
}

// Run calculation on page load
window.onload = function() {
    calculateTotal();
    
    // ADD REAL-TIME VALIDATION
    setupRealTimeValidation();
};

function toggleCustomInput() {
    const sexDropdown = document.getElementById("sex");
    const customSexInput = document.getElementById("customSex");

    if (sexDropdown.value === "O") {
        customSexInput.style.display = "block";
    } else {
        customSexInput.style.display = "none";
    }
}

function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
}

function numValue(id) {
    const v = document.getElementById(id).value;
    return v ? parseFloat(v) : null;
}

// ===== REAL-TIME DUPLICATE CHECK =====
let checkTimeout;

function setupRealTimeValidation() {
    const farmerNameInput = document.getElementById("farmer_name");
    const contactInput = document.getElementById("contact");
    
    // Create warning message element
    const warningDiv = document.createElement('div');
    warningDiv.id = 'duplicateWarning';
    warningDiv.style.cssText = `
        display: none;
        padding: 10px;
        margin-top: 10px;
        background-color: #fff3cd;
        border: 2px solid #ffc107;
        border-radius: 5px;
        color: #856404;
        font-weight: bold;
    `;
    contactInput.parentElement.appendChild(warningDiv);
    
    // Check on blur (when user leaves the field)
    contactInput.addEventListener('blur', async function() {
        await checkDuplicateRealTime();
    });
    
    farmerNameInput.addEventListener('blur', async function() {
        await checkDuplicateRealTime();
    });
}

async function checkDuplicateRealTime() {
    const farmerName = document.getElementById("farmer_name").value.trim();
    const contact = document.getElementById("contact").value.trim();
    const warningDiv = document.getElementById('duplicateWarning');
    
    // Only check if both fields have values
    if (!farmerName || !contact) {
        warningDiv.style.display = 'none';
        return;
    }
    
    try {
        const url = `/api/crops/check-duplicate?farmerName=${encodeURIComponent(farmerName)}&contact=${encodeURIComponent(contact)}`;
        const response = await fetch(url);
        
        if (response.ok) {
            const data = await response.json();
            
            if (data.exists) {
                const existingBarangay = data.barangay || 'another barangay';
                warningDiv.textContent = `‚ö†Ô∏è WARNING: Farmer "${farmerName}" with contact "${contact}" already exists in ${existingBarangay}!`;
                warningDiv.style.display = 'block';
            } else {
                warningDiv.style.display = 'none';
            }
        }
    } catch (error) {
        console.error('Error checking duplicate:', error);
    }
}

// ===== DUPLICATE CHECK FUNCTION =====
async function checkDuplicateFarmer(farmerName, contact) {
    if (!farmerName || !contact) {
        return { exists: false };
    }
    
    try {
        const url = `/api/crops/check-duplicate?farmerName=${encodeURIComponent(farmerName)}&contact=${encodeURIComponent(contact)}`;
        console.log('üîç Checking duplicate:', url);
        
        const response = await fetch(url);
        
        if (response.ok) {
            const data = await response.json();
            console.log('üì• Duplicate check result:', data);
            return data;
        }
    } catch (error) {
        console.error('‚ùå Error checking duplicate:', error);
    }
    
    return { exists: false };
}

// ===== SAVE BUTTON WITH DUPLICATE CHECK =====
document.getElementById("saveCropBtn").addEventListener("click", async () => {
    const barangay = getQueryParam("barangay") || "anao";
    const farmerName = document.getElementById("farmer_name").value.trim();
    const contact = document.getElementById("contact").value.trim();
    
    // Validation
    if (!farmerName) {
        alert("‚ö†Ô∏è Please enter farmer name!");
        return;
    }
    
    if (!contact) {
        alert("‚ö†Ô∏è Please enter contact number!");
        return;
    }
    
    // ===== CHECK FOR DUPLICATE =====
    console.log('üîç Checking for duplicate farmer...');
    const duplicateCheck = await checkDuplicateFarmer(farmerName, contact);
    
    if (duplicateCheck.exists) {
        const existingBarangay = duplicateCheck.barangay || 'another barangay';
        
        const confirmSave = confirm(
            `‚ö†Ô∏è WARNING: Farmer "${farmerName}" with contact "${contact}" already exists in ${existingBarangay}!\n\n` +
            `This might be a duplicate entry.\n\n` +
            `Click OK to save anyway, or Cancel to go back and check.`
        );
        
        if (!confirmSave) {
            console.log('‚ùå User cancelled save due to duplicate');
            return;
        }
        
        console.log('‚úÖ User confirmed save despite duplicate');
    }

    // ===== PROCEED WITH SAVE =====
    const cropData = {
        farmer_name: farmerName,
        contact: contact,
        age: document.getElementById("age").value ? parseInt(document.getElementById("age").value, 10) : null,
        sex: document.getElementById("sex").value,

        corn_area: numValue("cornArea"),
        corn_harvest: numValue("cornHarvest"),
        corn_fertilizer: document.getElementById("cornFertilizer").value,

        tomato_area: numValue("tomatoArea"),
        tomato_harvest: numValue("tomatoHarvest"),
        tomato_fertilizer: document.getElementById("tomatoFertilizer").value,

        eggplant_area: numValue("eggplantArea"),
        eggplant_harvest: numValue("eggplantHarvest"),
        eggplant_fertilizer: document.getElementById("eggplantFertilizer").value,

        bellpepper_area: numValue("bellpepperArea"),
        bellpepper_harvest: numValue("bellpepperHarvest"),
        bellpepper_fertilizer: document.getElementById("bellpepperFertilizer").value,

        squash_area: numValue("squashArea"),
        squash_harvest: numValue("squashHarvest"),
        squash_fertilizer: document.getElementById("squashFertilizer").value,

        okra_area: numValue("okraArea"),
        okra_harvest: numValue("okraHarvest"),
        okra_fertilizer: document.getElementById("okraFertilizer").value,

        cucumber_area: numValue("cucumberArea"),
        cucumber_harvest: numValue("cucumberHarvest"),
        cucumber_fertilizer: document.getElementById("cucumberFertilizer").value,

        stringbeans_area: numValue("stringbeansArea"),
        stringbeans_harvest: numValue("stringbeansHarvest"),
        stringbeans_fertilizer: document.getElementById("stringbeansFertilizer").value,

        sweet_potatoes_area: numValue("sweetpotatoArea"),
        sweet_potatoes_harvest: numValue("sweetpotatoHarvest"),
        sweet_potatoes_fertilizer: document.getElementById("sweetpotatoFertilizer").value,

        potato_area: numValue("potatoArea"),
        potato_harvest: numValue("potatoHarvest"),
        potato_fertilizer: document.getElementById("potatoFertilizer").value,

        spinach_area: numValue("spinachArea"),
        spinach_harvest: numValue("spinachHarvest"),
        spinach_fertilizer: document.getElementById("spinachFertilizer").value,

        kangkong_area: numValue("kangkongArea"),
        kangkong_harvest: numValue("kangkongHarvest"),
        kangkong_fertilizer: document.getElementById("kangkongFertilizer").value,

        carrots_area: numValue("carrotsArea"),
        carrots_harvest: numValue("carrotsHarvest"),
        carrots_fertilizer: document.getElementById("carrotsFertilizer").value,

        ampalaya_area: numValue("ampalayaArea"),
        ampalaya_harvest: numValue("ampalayaHarvest"),
        ampalaya_fertilizer: document.getElementById("ampalayaFertilizer").value,

        malunggay_area: numValue("malunggayArea"),
        malunggay_harvest: numValue("malunggayHarvest"),
        malunggay_fertilizer: document.getElementById("malunggayFertilizer").value,

        cassava_area: numValue("cassavaArea"),
        cassava_harvest: numValue("cassavaHarvest"),
        cassava_fertilizer: document.getElementById("cassavaFertilizer").value,

        cabbage_area: numValue("cabbageArea"),
        cabbage_harvest: numValue("cabbageHarvest"),
        cabbage_fertilizer: document.getElementById("cabbageFertilizer").value,

        lettuce_area: numValue("lettuceArea"),
        lettuce_harvest: numValue("lettuceHarvest"),
        lettuce_fertilizer: document.getElementById("lettuceFertilizer").value,

        baguio_beans_area: numValue("baguiobeansArea"),
        baguio_beans_harvest: numValue("baguiobeansHarvest"),
        baguio_beans_fertilizer: document.getElementById("baguiobeansFertilizer").value,

        cauliflower_area: numValue("cauliflowerArea"),
        cauliflower_harvest: numValue("cauliflowerHarvest"),
        cauliflower_fertilizer: document.getElementById("cauliflowerFertilizer").value,

        onion_area: numValue("onionArea"),
        onion_harvest: numValue("onionHarvest"),
        onion_fertilizer: document.getElementById("onionFertilizer").value,

        spring_onion_area: numValue("springonionArea"),
        spring_onion_harvest: numValue("springonionHarvest"),
        spring_onion_fertilizer: document.getElementById("springonionFertilizer").value,

        garlic_area: numValue("garlicArea"),
        garlic_harvest: numValue("garlicHarvest"),
        garlic_fertilizer: document.getElementById("garlicFertilizer").value,

        ginger_area: numValue("gingerArea"),
        ginger_harvest: numValue("gingerHarvest"),
        ginger_fertilizer: document.getElementById("gingerFertilizer").value,

        total_area_planted: numValue("totalAreaPlanted"),
        pesticide_used: document.getElementById("pesticideUsed").value,
        fertilizer_used: document.getElementById("fertilizerUsed").value
    };

    try {
        console.log('üíæ Saving crop data...');
        const response = await fetch(`/api/crops/${barangay}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(cropData)
        });

        if (response.ok) {
            alert("‚úÖ Data saved successfully!");
            window.location.href = `Crops_Overview.html?barangay=${barangay}`;
        } else {
            const errorText = await response.text();
            alert("‚ùå Failed to save data: " + errorText);
        }
    } catch (error) {
        console.error("‚ùå Error saving data:", error);
        alert("‚ùå An error occurred while saving data.");
    }
});
</script>
</body>
</html>