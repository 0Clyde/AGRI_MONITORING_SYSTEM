<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Farmer Fisheries Details</title>
    <link rel="stylesheet" href="farmersfisheries_info.css">
</head>
<body>

<header class="header">
    <button class="back-btn" onclick="goBack()">←</button>
    <h1 class="title" id="farmerTitle">Farmer – Fisheries Details</h1>

    <div class="header-actions">
        <button class="btn secondary" id="editBtn">Edit</button>
    </div>
</header>

<main class="main-container">
    <!-- Farmer basic info card -->
    <section class="farmer-info-card">
        <h2 class="section-title">Farmer Information</h2>
        <div class="farmer-info-row">
            <div>
                <span class="label">Name:</span>
                <span id="farmerName">—</span>
            </div>
            <div>
                <span class="label">Contact:</span>
                <span id="farmerContact">—</span>
            </div>
            <div>
                <span class="label">Age:</span>
                <span id="farmerAge">—</span>
            </div>
            <div>
                <span class="label">Sex:</span>
                <span id="farmerSex">—</span>
            </div>
            <div>
                <span class="label">Barangay:</span>
                <span id="farmerBarangay">—</span>
            </div>
            <div>
                <span class="label">Farmer ID:</span>
                <span id="farmerIdLabel">—</span>
            </div>
        </div>
    </section>

    <!-- Fisheries table -->
    <section class="fisheries-section">
        <div class="fisheries-header">
            <h2 class="section-title">Fisheries and Details</h2>
            <span class="section-subtitle">Shows list of fish types, ponds, area, and stocks.</span>
        </div>

        <div class="table-wrapper">
            <table class="fisheries-table">
                <thead>
                    <tr>
                        <th>Fish Type</th>
                        <th>Number of Ponds</th>
                        <th>Area (sq.m)</th>
                        <th>No. of Stocks</th>
                    </tr>
                </thead>
                <tbody id="fisheriesTableBody">
                    <!-- Rows injected by JS -->
                </tbody>
            </table>
        </div>
    </section>

    <!-- Summary section -->
    <section class="high-value-section">
        <div class="right-panel">
            <h3>Fisheries Summary</h3>

            <label>Total Pond Area:</label>
            <input type="text" id="totalPondArea" disabled>

            <label>Total Average Production:</label>
            <input type="text" id="totalAvgProduction" disabled>

            <label>Total No. of Feeds Used:</label>
            <input type="text" id="totalFeedsUsed" disabled>
        </div>
    </section>
</main>

<script>
function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
}

function goBack() {
    const barangay = getQueryParam("barangay") || "";
    if (barangay) {
        window.location.href = `Fisheries_Overview.html?barangay=${encodeURIComponent(barangay)}`;
    } else {
        window.history.back();
    }
}

document.addEventListener("DOMContentLoaded", async () => {
    const barangay = getQueryParam("barangay") || "";
    const farmerId = getQueryParam("farmerId") || "";
    
    if (!barangay || !farmerId) {
        alert("Missing barangay or farmer ID!");
        return;
    }
    
    await loadFarmerDetails(barangay, farmerId);
});

// Edit button functionality
document.getElementById("editBtn").addEventListener("click", () => {
    const barangay = getQueryParam("barangay") || "";
    const farmerId = getQueryParam("farmerId") || "";
    
    // Redirect to edit page
    window.location.href = `Fisheries_edit.html?barangay=${encodeURIComponent(barangay)}&farmerId=${encodeURIComponent(farmerId)}`;
});

async function loadFarmerDetails(barangayParam, farmerIdParam) {
    const tbody = document.getElementById("fisheriesTableBody");

    try {
        console.log(`Fetching farmer ${farmerIdParam} in barangay ${barangayParam}`);
        const response = await fetch(`/api/fisheries/${barangayParam}/${farmerIdParam}`);
        
        if (!response.ok) {
            throw new Error(`Failed to load farmer fisheries: ${response.statusText}`);
        }

        const farmer = await response.json();
        console.log("Farmer detail:", farmer);

        // FIXED: Use camelCase field names to match Java model
        document.getElementById("farmerName").textContent = farmer.farmerName || "Unnamed Farmer";
        document.getElementById("farmerContact").textContent = farmer.contact || "N/A";
        document.getElementById("farmerAge").textContent = farmer.age || "N/A";
        document.getElementById("farmerSex").textContent = farmer.sex || "N/A";
        document.getElementById("farmerBarangay").textContent = farmer.barangay || "Unknown";
        document.getElementById("farmerIdLabel").textContent = farmer.id || "N/A";

        // FIXED: Render fisheries data from the flat Fish object
        renderFisheriesTable(farmer);

        // Update summary fields
        document.getElementById("totalPondArea").value = farmer.totalPondArea || "0";
        document.getElementById("totalAvgProduction").value = farmer.totalAvgProduction || "0";
        document.getElementById("totalFeedsUsed").value = farmer.totalFeedsUsed || "0";

    } catch (err) {
        console.error(err);
        alert("Error loading farmer data: " + err.message);
        tbody.innerHTML = `<tr><td colspan="4" class="empty-row">Error loading data.</td></tr>`;
    }
}

function renderFisheriesTable(farmer) {
    const tbody = document.getElementById("fisheriesTableBody");
    tbody.innerHTML = "";

    // Define all fish types with their field names
    const fishTypes = [
        { name: "Tilapia", pondsField: "tilapiaPonds", areaField: "tilapiaArea", stocksField: "tilapiaStocks" },
        { name: "Bangus", pondsField: "bangusPonds", areaField: "bangusArea", stocksField: "bangusStocks" },
        { name: "Catfish (Hito)", pondsField: "hitoPonds", areaField: "hitoArea", stocksField: "hitoStocks" },
        { name: "Crawfish", pondsField: "crawfishPonds", areaField: "crawfishArea", stocksField: "crawfishStocks" }
    ];

    let hasData = false;

    // Only show rows where there are ponds, area, or stocks
    fishTypes.forEach(fish => {
        const ponds = farmer[fish.pondsField] || 0;
        const area = farmer[fish.areaField] || 0;
        const stocks = farmer[fish.stocksField] || 0;

        // Only add row if there's data
        if (ponds > 0 || area > 0 || stocks > 0) {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${fish.name}</td>
                <td>${ponds}</td>
                <td>${area}</td>
                <td>${stocks}</td>
            `;
            tbody.appendChild(tr);
            hasData = true;
        }
    });

    // If no fisheries at all
    if (!hasData) {
        tbody.innerHTML = `<tr><td colspan="4" class="empty-row">No fisheries records yet.</td></tr>`;
    }
}
</script>

</body>
</html>